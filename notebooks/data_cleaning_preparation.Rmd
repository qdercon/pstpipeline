---
title: "Setup and data cleaning, plus transdiagnostic factor derivation"
output: html_notebook
---

### Setup

**Fix data paths**

```{r setup}
library(reticulate)
knitr::opts_knit$set(root.dir = normalizePath("~/Research Work/October 2021/pstpipeline"))
knitr::opts_chunk$set(options(reticulate.repl.quiet = TRUE))
use_python("~/Research Work/October 2021/pstpipeline")
```

**Import Python dependencies**

```{python}
# make sure correct Python interpreter selected in project options
import pandas as pd
import numpy as np
import joblib, io
import seaborn as sns
import matplotlib.pyplot as plt
from contextlib import redirect_stdout

pal = ['#4f4f4f', '#B80044', '#0e79b2', '#861388', '#171a21', '#a5a5a5']
light_pal =['#9e9e9e', '#e86d9a', '#64abd1']

out = io.StringIO()
```

### Import and clean raw data

```{r results = 'hide'}
# single <- pstpipeline::import_single("data/example_res_single.txt", plot = TRUE, add_sex= TRUE)
# multiple <- pstpipeline::import_multiple("data/example_res_multiple.txt", separate = FALSE, indiv = TRUE)
# plot_id1 <- pstpipeline::plot_single(subjID = 1, multiple)

all_res_split <- pstpipeline::import_multiple("data/all_995_complete.txt", add_sex = TRUE)

# saveRDS(all_res_split, "data/all_res_split.RDS")
```

### Calculate factor scores using model fit previously

**Write and load questionnaire data, and import classifier**

```{r}
# all_res_split <- readRDS("data/all_res_split.RDS")
readr::write_csv(
  dplyr::bind_rows(
    all_res_split$non_distanced$gillan_questions,
    all_res_split$distanced$gillan_questions
  ),
  "data/factor_prediction/questionnaire_subset_all_935.csv"
)
```

```{python}
questionnaire_likert = pd.read_csv('data/factor_prediction/questionnaire_subset_all_935.csv')
clf = joblib.load('data/factor_prediction/gillan_classifier_78.pkl')
```

**Predict factor scores in all participants**

```{python}
factor_score_pred = clf.predict(questionnaire_likert.iloc[:, 1:])
factor_score_pred = pd.DataFrame(factor_score_pred, columns=['AD', 'Compul', 'SW'])
factor_score_pred.loc[:, 'subjID'] = questionnaire_likert['subjID'].values

factor_score_pred.head()
# factor_score_pred.to_csv('data/factor_prediction/all_935_predicted_factor_scores.csv')
```

```{python}
factors = ['Anxiety & depression', 'Compulsivity', 'Social withdrawal']

f, ax = plt.subplots(1, 3, figsize=(10, 3), dpi=100, facecolor='white')

for n, factor in enumerate(['AD', 'Compul', 'SW']):
  with redirect_stdout(out):
    sns.histplot(factor_score_pred[factor], ax=ax[n], color=light_pal[n], kde=True)
    ax[n].set_xlabel('Score')
    if n == 0:
        ax[n].set_ylabel('Density')
    ax[n].set_title(factors[n], fontweight='light')
    
plt.tight_layout()
plt.savefig('notebooks/plots/all_935_factor_scores.png')

```
```{r}
knitr::include_graphics("notebooks/plots/all_935_factor_scores.png")
```

**How do these distributions compare to those originally obtained by [Gillan et al (2016)](https://elifesciences.org/articles/11305)?**

```{python}
factor_scores_gillan = pd.read_csv('data/factor_prediction/gillan_scores.csv').rename(columns={"CIT": "Compul"})

f, ax = plt.subplots(1, 3, figsize=(10, 3), dpi=100, facecolor='white')

col = 0
for n, factor in enumerate(['AD', 'Compul', 'SW']):
  with redirect_stdout(out):
    for p, a in enumerate([factor_score_pred, factor_scores_gillan]):
      sns.histplot(a[factor], ax=ax[n], color=pal[col], kde=True)
      col += 1
    ax[n].set_xlabel('Score')
    if n == 0:
      ax[n].set_ylabel('Density')
    ax[n].set_title(factors[n], fontweight='light')
    
plt.tight_layout()
# plt.savefig('notebooks/plots/gillan2016_factor_scores.png')
```
Scores for the "Compulsivity" factor seem relatively close to that seen in the study by [Gillan et al (2016)](https://elifesciences.org/articles/11305), while scores for the "Anxiety/Depression" factor are slightly higher. This may be explained by our aim to actively recruit a sample which included a similar proportion of individuals reporting a psychiatric diagnosis (past or present) to the UK population. Scores for the "Social Withdrawal" were notably higher than those seen in the original dataset; this may be partly confounded by the fact that data collection occurred in April-May 2021, when the UK was not yet fully out of lockdown restrictions.

```{r}
knitr::include_graphics("notebooks/plots/gillan2016_factor_scores.png")
```
